# 揭棋 AI Jieqi AI （UI 修正版）

本项目为 [miaosiSari](https://github.com/miaosiSari/Jieqi) 的开源代码的 UI 修正版。未改动走子逻辑，主要对 UI 进行了修正与增强。

![界面示例]([docs/screenshot.png](https://github.com/zyjopensource/Jieqi/blob/main/jieqi_20260217155735.png))
*图中为用此软件下出的一个很有意思的局面，双方四车相对，红方将走子，问如何走最好？*

## 使用说明

首先安装依赖：
```bash
pip install pygame
```

然后在 Python 3 环境中运行 `gui.py`：
```bash
python gui.py
```

### 引擎配置

默认使用 `musesfish_pvs_20260215.py` 作为引擎。该引擎在 `musesfish_pvs_20210815.py` 之上做了少量补丁：
- **未改动走子逻辑**，主要是适配 UI 的修改
- 对搜索效率进行了少量代码优化
- **已将 NULLMOVE 默认设为 False**，个人评估这一设置显著增强了 AI 的棋力
- 与原版本一样，需要走棋到最终吃掉帅/将的一步达到终局。

## ✨ 改进内容

### 🖥️ UI / 交互增强
- **子进程通信**：`Popen` 改用 `errors="replace"`，避免跨机器运行时的解析错误。
- **错误处理**：增加 stderr 读取线程，后台读取并打印引擎报错，避免 stderr 堵塞导致子进程/GUI 假死。
- **颜色判定**：按逐棋子解析，修复了黑棋过河变白的 bug。
- **选中交互**：支持再次点击同一棋子或点击空白区域取消选择。
- **安全退出**：引入 `stop_event` 协调各线程退出，并规避关闭窗口卡死。
- **棋子显示优化**：
  - 增大字体字号、启用加粗
  - 实现文字居中
  - 添加棋子边框效果及内圆纹路
- **暗子处理**：暗子画圆但不渲染“暗”字（显示为留白）。
- **走子标记**：记录上一手起点，走子后在起始格绘制标记。
- **吃子区**：在棋盘下方用圆形棋子绘制两行吃子区，并用右上角小点标记暗子。
- **计时显示**：新增对局计时显示。
- **将军提示**：新增“将军”提示功能。
- **回顾功能**：新增棋局结束后的对局回顾功能与按键。
- **自我对弈**：新增 AI 自我对弈功能。

### ⚙️ 性能与稳定性
- **降低 CPU 占用**：
  - 将 `pygame.display.update()` 从“每行更新”改为“最后一行统一更新”
  - 主循环从 `for event in pygame.event.get()` 改为 `pygame.event.wait()` + `pygame.event.get()`
  - 将 `Board.draw()` 中读取队列改为阻塞式 `self.stdout.get()`
- **搜索效率优化**：做了少量搜索提速代码优化。
- **THINK_TIME 修正**：
  - 之前超时只在迭代加深层间检查，现已将时间检查下沉到 `alphabeta()` 内部，实现真正可中断。
  - 新增思考时间增长：前 N 步线性增长思考时间。

### 🐞 Bug 修复
- 修复棋局分数score显示不正确的 bug。
- 修复暗子颜色判定错误。

### ♟️ 引擎调整
- 默认关闭 NULLMOVE（经测试显著增强棋力）。
- 新增显示每步搜索累计访问的局面数。

## 📜 许可证

本项目基于原仓库 [miaosiSari/Jieqi](https://github.com/miaosiSari/Jieqi) 进行 UI 修正，遵循原项目的开源许可证。

---

**揭棋 AI** —— 体验暗子翻开的乐趣与传统象棋的经典攻杀！
